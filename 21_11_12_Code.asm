		ORG	8000H
DATAOUT		EQU	0FFF0H
DATAIN		EQU	0FFF1H

DLED		EQU	0FFC1H
ALED0		EQU	0FFC2H
ALED1		EQU	0FFC3H

REP_COUNT	EQU	5

VSEC		EQU	30H
VMIN		EQU	31H
VHOUR		EQU	32H
VBUF		EQU	33H
		
		ORG	8000H
		MOV	SP,#60H
		MOV	VHOUR,#80H
		MOV	VMIN,#51H
		MOV	VSEC,#00H
		CALL	DISPLAY

MAIN:		CALL	FINDKEYCODE
		JB	ACC.4,ERR
		MOV	VBUF,A
		CALL	SHIFT
		CALL	DISPLAY
		CALL	BOUNCE

		MOV 	A,VHOUR
		MOV	B,VHOUR
		ANL	A,#240
		ANL	B,#15
		SWAP	A
		MOV	R5,B
		MOV	B,#10
		MUL	AB
		ADD	A,R5
		MOV	R5,A

		MOV 	A,VMIN
		MOV	B,VMIN

		ORL	A,B
		JZ	ERR
	
		MOV	A,VMIN
		ANL	A,#240
		ANL	B,#15
		SWAP	A
		MOV	R6,B
		MOV	B,#10
		MUL	AB
		ADD	A,R6
		MOV	R6,A
	
		MOV	A,R5
		MOV	B,R6

		DIV	AB
		
		MOV	R5,B
		MOV	A,R5
		MOV	B,#10
		DIV	AB
		
		MOV	R6,A
		
		MOV 	R7,B
		SWAP	A
		ORL	A,R7
		MOV	DPTR,#DLED
		MOVX	@DPTR,A

		JMP	MAIN

ERR:		CALL	ERROR
		JMP	MAIN
	
BOUNCE:		CALL	DELAY

RELOAD:		MOV	A,#0
		CALL	SUBKEY
		CPL	A
		JNZ	RELOAD
		
		CALL	DELAY
		RET

ERROR:		MOV	R4,#REP_COUNT

ERR_1:		MOV	VSEC,#0
		MOV	VMIN,#0
		MOV	VHOUR,#0
		CALL	DISPLAY
		
		MOV	R3,#10
		FIRST:	CALL	DELAY
		DJNZ	R3,FIRST
		
		MOV	VSEC,#0FFH
		MOV	VMIN,#0FFH
		MOV	VHOUR,#0FFH
		CALL	DISPLAY

		MOV	R3,#10
SECOND:		CALL	DELAY
		DJNZ	R3,SECOND
		DJNZ	R4,ERR_1
		RET

DELAY:		MOV	R0,#020H

REPEAT:		MOV	R1,#0FFH
		DJNZ	R1,$
		DJNZ	R0,REPEAT
		RET

SHIFT:		MOV	A,VHOUR
		SWAP	A
		MOV	VHOUR,A

		MOV	A,VMIN
		SWAP	A
		MOV	VMIN,A

		;MOV	A,VSEC
		;SWAP	A
		;MOV	VSEC,A

		MOV	A,VMIN
		MOV	R0,#VHOUR
		XCHD	A,@R0
		MOV	VMIN,A

		;MOV	A,VSEC
		;MOV	R0,#VMIN
		;XCHD	A,@R0
		;MOV	VSEC,A

		MOV	A,VBUF
		MOV	R0,#VMIN
		XCHD	A,@R0
		RET

FINDKEYCODE:	PUSH	PSW
		SETB	PSW.4
		SETB	PSW.3

INITIAL: 	MOV	R1,#00H
		MOV	A,#11101111B
		SETB	C

COLSCAN: 	MOV	R0,A
		INC	R1
		CALL	SUBKEY

		CJNE	A,#0FFH,RSCAN
		MOV	A,R0
		SETB	C
		RRC	A
		JNC	INITIAL
		JMP	COLSCAN

RSCAN:		MOV	R2,#00H
ROWSCAN:	RRC	A
		JNC	MATRIX
		INC	R2
		JMP	ROWSCAN

MATRIX:		MOV	A,R2
		MOV	B,#05H
		MUL	AB
		ADD	A,R1
		CALL	INDEX
		POP	PSW
		RET

SUBKEY: 	MOV	DPTR,#DATAOUT
		MOVX	@DPTR,A
		MOV	DPTR,#DATAIN
		MOVX	A,@DPTR
		RET
		DISPLAY:	MOV	DPTR,#DLED
		MOV	A,VSEC
		MOVX	@DPTR,A
		MOV	DPTR,#ALED0
		MOV	A,VMIN
		MOVX	@DPTR,A
		
MOV		DPTR,#ALED1
		MOV	A,VHOUR
		MOVX	@DPTR,A
		RET

RWKEY		EQU	10H
COMMA		EQU	11H
PERIOD		EQU	12H
GO		EQU	13H
REG		EQU	14H
CD		EQU	15H
INCR		EQU	16H
ST		EQU	17H
RST		EQU	18H

INDEX:		MOVC	A,@A+PC
		RET

KEYBASE: 	DB	ST	;1
		DB	INCR	;2
		DB	CD	;3
		DB	REG	;4
		DB	GO	;5
		DB	0CH	;6
		DB	0DH	;7	
		DB	0EH	;8
		DB	0FH	;9
		DB	COMMA	;10
		DB	08H	;11
		DB	09H	;12
		DB	0AH	;13
		DB	0BH	;14
		DB	PERIOD	;15
		DB	04H	;16
		DB	05H	;17
		DB	06H	;18
		DB	07H	;19
		DB	RWKEY	;20
		DB	00H	;21
		DB	01H	;22
		DB	02H	;23
		DB	03H	;24
		DB	RST	;25


END